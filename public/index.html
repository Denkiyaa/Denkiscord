<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
  <meta charset="UTF-8">
  <title>Denkiscord - Chat, Dosya Y√ºkleme, Ctrl+V</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Genel d√ºzen */
    body { margin: 0; font-family: Arial, sans-serif; }
    #container { display: flex; height: 100vh; }
    
    /* Sol panel: Kanallar ve kullanƒ±cƒ± listesi */
    #sidebar { width: 250px; background-color: #2f3136; color: white; display: flex; flex-direction: column; }
    #sidebar h2 { text-align: center; padding: 10px 0; border-bottom: 1px solid #23272a; margin: 0; }
    #channelList { list-style: none; padding: 0; margin: 0; }
    #channelList li { padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #23272a; }
    #channelList li.active { background-color: #40444b; }
    #channelUserList { list-style: none; padding: 0; margin: 0; }
    #channelUserList li { padding: 5px 20px; border-bottom: 1px solid #23272a; }
    
    /* Saƒü panel: Chat, Ses, Ekran Payla≈üƒ±mƒ± */
    #mainContent { flex-grow: 1; background-color: #36393f; color: white; display: flex; flex-direction: column; }
    #chatArea { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #40444b; }
    .chat-message { margin-bottom: 8px; }
    .chat-image, .chat-video { max-width: 200px; max-height: 200px; cursor: pointer; }
    
    /* Chat input alanƒ± */
    #chatInputContainer {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 5px;
    }
    #message { flex: 1; padding: 5px; }
    #sendBtn, #uploadBtn { padding: 5px 10px; cursor: pointer; }
    
    /* √ñnizleme alanƒ±: K√º√ß√ºk thumbnail */
    #pastePreviewContainer {
      margin: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #pastePreview, #pasteVideoPreview {
      max-width: 80px;
      max-height: 80px;
      object-fit: cover;
      cursor: pointer;
    }
    
    /* Lightbox stilleri */
    #lightboxOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100000;
      cursor: pointer;
    }
    
    /* Voice alanƒ± */
    #voiceArea { padding: 10px; border-top: 1px solid #23272a; background-color: #2f3136; display: flex; align-items: center; }
    #voiceIndicator { width: 50px; height: 50px; border: 3px solid gray; border-radius: 50%; display: inline-block; margin-right: 10px; text-align: center; line-height: 50px; font-size: 14px; }
    #voiceIndicator.speaking { border-color: green; }
    #nicknameDisplay { font-weight: bold; }
    
    /* Ekran payla≈üƒ±mƒ± alanƒ± */
    #screenVideos { height: 300px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: #2f3136; }
    
    /* Kontrol Paneli */
    #controlPanel { 
      position: fixed; bottom: 10px; left: 10px; background-color: rgba(47,49,54,0.9); 
      padding: 10px; border-radius: 4px; z-index: 10000; display: none; 
      gap: 5px; align-items: center; 
    }
    #controlPanel button { padding: 5px 10px; font-size: 14px; border: none; background: #7289da; color: white; border-radius: 4px; cursor: pointer; }
    #controlPanel button:hover { background: #677bc4; }
    #connectionIndicator { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: red; color: white; }
    #micSensitivityControl { display: flex; align-items: center; gap: 5px; font-size: 12px; color: white; }
    
    /* Context Menu */
    #contextMenu { display: none; position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; z-index: 20000; border-radius: 4px; }
    #contextMenu label { font-size: 12px; }
    #contextMenu input { margin-left: 5px; }
  </style>
</head>
<body>
  <!-- Ana Container -->
  <div id="container">
    <!-- Sol Panel -->
    <div id="sidebar">
      <h2>Kanallar</h2>
      <ul id="channelList">
        <li id="genelChannel" class="active">
          Genel
          <ul id="channelUserList"></ul>
        </li>
      </ul>
    </div>
    <!-- Saƒü Panel -->
    <div id="mainContent">
      <div id="chatArea"></div>
      <div id="chatInputContainer">
        <input id="message" type="text" placeholder="Mesaj yazƒ±n...">
        <!-- Medya Y√ºkle Butonu -->
        <button id="uploadBtn">üìé</button>
        <!-- G√∂nder Butonu -->
        <button id="sendBtn">G√∂nder</button>
        <!-- Gizli Dosya Inputu -->
        <input type="file" id="hiddenMediaInput" accept="image/*,video/*" style="display: none;">
      </div>
      <!-- Yapƒ±≈ütƒ±rma √ñnizlemesi -->
      <div id="pastePreviewContainer">
        <img id="pastePreview" style="display: none;" />
        <video id="pasteVideoPreview" style="display: none;" controls></video>
      </div>
      <div id="voiceArea">
        <div id="voiceIndicator">Sen</div>
        <div id="nicknameDisplay"></div>
      </div>
      <div id="screenVideos"></div>
    </div>
  </div>

  <!-- Kontrol Paneli -->
  <div id="controlPanel" style="display: none;">
    <div id="connectionIndicator">Baƒülƒ±</div>
    <button id="disconnectBtn">‚ùå Disconnect</button>
    <button id="muteBtn">üîá Mute</button>
    <button id="deafBtn">üôâ Deaf</button>
    <button id="screenShareCtrlBtn">üñ•Ô∏è Screen Share</button>
    <div id="micSensitivityControl">
      Mic Sensitivity: <input type="range" id="micSensitivitySlider" min="1" max="100" value="20">
    </div>
  </div>

  <!-- Context Menu for Volume Control -->
  <div id="contextMenu">
    <label>Volume:</label>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
  </div>

  <!-- Socket.IO ve SimplePeer K√ºt√ºphaneleri -->
  <script src="/socket.io/socket.io.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js" defer></script>

  <!-- Global ve Mod√ºler JS Dosyalarƒ± -->
  <script src="js/globals.js" defer></script>
  <script src="js/socket.js" defer></script>
  <script src="js/chat.js" defer></script>
  <script src="js/voice.js" defer></script>
  <script src="js/screenShare.js" defer></script>
  <script src="js/controlPanel.js" defer></script>
  <script src="js/app.js" defer></script>

  <!-- Medya Y√ºkleme ve Paste ƒ∞≈ülemleri -->
  <script defer>
    let pendingFile = null;
    let pendingFileType = null;

    window.addEventListener('DOMContentLoaded', () => {
      const uploadBtn = document.getElementById('uploadBtn');
      const hiddenMediaInput = document.getElementById('hiddenMediaInput');
      const pastePreview = document.getElementById('pastePreview');
      const pasteVideoPreview = document.getElementById('pasteVideoPreview');
      const sendBtn = document.getElementById('sendBtn');
      const messageInput = document.getElementById('message');

      // Dosya y√ºkleme butonuna tƒ±klayƒ±nca, gizli input tetiklenir.
      uploadBtn.addEventListener('click', () => {
        hiddenMediaInput.click();
      });

      // Dosya se√ßildiƒüinde √∂nizleme g√∂ster.
      hiddenMediaInput.addEventListener('change', async () => {
        const file = hiddenMediaInput.files[0];
        if (!file) return;
        await showPreview(file);
      });

      // Paste (Ctrl+V) olayƒ±: Clipboard'dan dosya al.
      document.addEventListener('paste', async (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.kind === 'file') {
            const file = item.getAsFile();
            await showPreview(file);
          }
        }
      });

      // G√∂nder butonuna tƒ±klayƒ±nca: hem metin hem de varsa dosya mesajƒ± g√∂nder.
      sendBtn.addEventListener('click', async () => {
        const textMsg = messageInput.value.trim();

        // Eƒüer pendingFile varsa, √∂nce dosyayƒ± y√ºkle.
        if (pendingFile) {
          const url = await uploadFile(pendingFile);
          if (url) {
            socket.emit('chat message', {
              nickname: window.nickname,
              type: pendingFileType,
              content: url
            });
          }
          // Temizle
          pendingFile = null;
          pendingFileType = null;
          pastePreview.style.display = 'none';
          pastePreview.src = '';
          pasteVideoPreview.style.display = 'none';
          pasteVideoPreview.src = '';
        }

        // Metin mesajƒ± varsa g√∂nder.
        if (textMsg) {
          socket.emit('chat message', {
            nickname: window.nickname,
            type: "text",
            content: textMsg
          });
          messageInput.value = '';
        }
      });
    });

    async function showPreview(file) {
      let type = "image";
      if (file.type.startsWith("video/")) {
        type = "video";
      } else if (!file.type.startsWith("image/")) {
        showTemporaryMessage("Yalnƒ±zca g√∂rsel veya video y√ºklenebilir");
        return;
      }
      pendingFile = file;
      pendingFileType = type;

      if (type === "image") {
        const reader = new FileReader();
        reader.onload = (e) => {
          pastePreview.src = e.target.result;
          pastePreview.style.display = 'inline';
          pasteVideoPreview.style.display = 'none';
        };
        reader.readAsDataURL(file);
      } else {
        const reader = new FileReader();
        reader.onload = (e) => {
          pasteVideoPreview.src = e.target.result;
          pasteVideoPreview.style.display = 'inline';
          pastePreview.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
      showTemporaryMessage("√ñnizleme hazƒ±r; G√∂nder butonuna basƒ±n");
    }

    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('media', file);
      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.fileUrl) {
          showTemporaryMessage("Dosya y√ºklendi, mesaj olarak g√∂nderiliyor");
          return data.fileUrl;
        } else {
          showTemporaryMessage("Dosya y√ºklenemedi");
          return null;
        }
      } catch (err) {
        console.error("Y√ºkleme hatasƒ±:", err);
        showTemporaryMessage("Dosya y√ºklenirken hata olu≈ütu");
        return null;
      }
    }
  </script>
</body>
</html>
